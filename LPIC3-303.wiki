[[index|back]]

= LPIC-3 303: Security =
== 325.1 X.509 Certificates and Public Key Infrastructures ==
=== Cryptography Concepts Part 1 ===
Cryptography Concepts
PKI and Trust Chains
Creating and working with certificates
Operating a Certificate Authority

What is Cryptography?
Practice and study of techniques for secure communication in the presence of third parties called adversaries

Computational context
Symmetric or assymetric encryption

Protecting data from untrusted third parties
Ensure data between parties is authentic

Encryption is how we can pass info across channels without compromising the content or integrity of the data

Uses of Cryptography
Data Encryption
Cipher to render data unreadable

Data Integrity
Make sure what we send is what they receive
Make sure it's not tampered or at least alert if it was

Authentication
Confirm we are who we say we are

Two primary elements to cryptography
Key
Used to encrypt data
Like a password
Must be secret
Can be multiple keys in some situations
Needs to be kept private

Algorithm
Method of encryption
Takes plain text data and makes it unreadable to third party
Also unencrypts data
May be public
Need to know how to use key
Examples: 3DES, blowfish, AES

A cipher (algorithm) is used to scramble information

Ciphertext may be deciphered (unencrypted) with a key

Two types of encryption
Symmetric and Asymmetric encryption

=== Cryptography Concepts Part 2 ===
Symmetric Encryption:
Only one key
Both parties must know key
Generally faster than asymmetric encryption

Example algorithms: Blowfish, AES

Asymmetric
Two keys
Encryption is public
Decryption key is private

^^ SSH key

Example algorithms: RSA, DSA

Good for digital signatures, key distribution and digital certificates

Data Integrity through hashes
Hash converts a string of any length to an output string of fixed length

Each string provides a unique hash

Hashing is generally used one way

A salt may be used to improve security

Add random text to ciphertext to improve security
Don't have just hash to crack, need to handle random data as well

Common hashing algorithms,
crc-32 (don't use, insecure), md5, sha-1 (most common)

If file is modified md5 sum changes

=== PKI and Trust Chains ===
PKI = Public Key Infrastructure

Use ID, Gov't and airline as an example
ID to verify who you are to airline
Gov't provisioned ID, valid institution

PKI is made up of a hierarcy of Certificate Authorities (CA) and a Certificate Signing Request (CSR) process

Root Trusted
Top level CA
Client

CA
Trusted third party that validates the authenticity of a public key
Root trusted CA that signs and vets CA certificates
By trusting a CA cert you ctrust all certs signed by that CA

CSR are essentially public keys that are generated and submitted to a CA to be signed
When a CA signs a CSR it produces a certificate that is trusted by the signing CA
CA can also invalidate a cert if needed by using either OCSP (Online Certificate Status Protocol) or by using a CRL (Certificate Revocation List)
CRL almost completely deprecited in favor of OCSP

=== Request, Sign, and Manage Certificates ===
Creating and working with certificates

Creating a private key
openssl genrsa -ALGORITHM -out KEY KEYSIZE
openssl genrsa -aes128 -out mykey.pem 2048

Generating a self-signed cert (public key)
openssl req -utf8 -new -key KEY -x509 -days LIFESPAN -out CERT

Display certificate
openssl x509 -in CERT -text -noout

Creating a CSR
openssl req -new -key PRIVKEY -out CSR

The openssl command creates PEM formatted files by default.
Other formats,
DER - A binary form of ASCII PEM
P7B/PKCS#7 - Base64 encoded ASCII popular in Windows
PFX/PKCS#12 - A binary format capable of storing keys, certs and intermediary certs together.

Openssl command can convert between formats.
Check x509, rsa, pkcs7 or pkcs12 man pages.
Doesn't work with all formats.

=== Operating a Certificate Authority ===
Understangind CAs
What makes a CA is really a unique key pair

A CA public key is typically signed by another CA that is trusted

Three primary reponsibilities
Sign valid CSRs
Maintain security of their private key
Revoke compromised or misused certificates

Operating a CA
Creating a private key
openssl genrsa -ALGORITHM -out KEY KEYSIZE
openssl genrsa -aes128 -out mykey.key 2048

Generating a self-signed certificate (public key)
openssl -utf8 -new -key KEY -x509 -days LIFESPAN -out CERT

Add -set_serial SERIAL for a CA certificate

Signing a CSR as a CA (requires CA keys)
openssl ca -in CSR -out CRT

== 325.2 X.509 Certificates for Encryption, Signing and Authentication ==
=== SSL, TLS, and Apache HTTPD Server ===
SSL, TLS, and common Transport Security Layer Threats
Working with Apache's mod_ssl
Troubleshooting using openssl

SSL stands for Secure Sockets Layer
SSL was the original protocol for securing web traffic
Latest version is SSLV3 which is deprecated
It should not be used

TLS for Transport Layer Security
TLS successor to SSL begginning with TLS 1.0
TLS 1.2 is the current standard
TLS 1.3 proposed as new standard

Transport Layer Security
TLS and SSL aim to address the issue of secure communication over a public network
protocols meet the following needs
Securely encrypt exchanged data
Authenticate at least one part
Ensure data integrity
Prevent replay attacks

TLS achieves this through the use of PKI as well as general encryption practice

"Man in the middle" style attacks can be a threat to TLS.
Attack third party intercepts and/or alters data between parties
Use TLS 1.2 or newer as soon as feasible
Encrypt all traffic
Each TLS update, vulns like POODLE and BEAST are patched and weak ciphers are deprecated
Some security measures do lie with the client (not using bank website on public wifi)

=== The ssl.conf File: Important Directives and Security Focused Configurations ===
Working with mod_ssl
Secure http traffic with PKI:
SSLCertificateFile CERT
SSLCertificateKeyFile KEY

Authenticate with a client certificate:
SSLVerifyClient require
SSLVerifyDepth 1
SSLCACertificateFile CACERT

Configure Cipher usage:
SSLCipherSuite HIGH:!aNULL:!MD5

OCSP Stapling:
SSLUseSXtapling On
SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

=== Understanding SNI and HSTS ===
Apache and mod_ssl
Server name Indication (SNI)
Only able to bind a cert to a single socket
One cert for every IP/port combo

Starting with Apache 2.2.12 and OpenSSL 0.9.8j
It's possible to have many certs on the same socket
Allows the use of name-based virtual hosts with unique certificates
SSLStrictSNIVHostCheck
Directive for SNI
On or off
Non-SNI clients able to use SNI virtualhosts
Can cause issues

HTTPS Strict Transport Security (HSTS)
HSTS is a way to encourage encryption for an entire domain rather than select parts
Special header is sent by teh web server which instructs the browser to direct all traffic over SSL

header always set Strict-Transport-Security "max-age=300; includeSubDomains;preload".

max age important, what tells browser how long to operate
When cutting over a legacy website you might need to roll back
TTL
Want to start with a low number
If it goes sideways browser will check on a non-secure port
Preload
List of known hsts website
Tells browser to treat site as a known HSTS website

=== Using the openssl Command to Work with Certificates and Web Servers ===
More on openssl
Establish a secure connection:
openssl s_client -connect HOST

Validate a trust chain:
openssl verify -verbose CERT

View Certificate details:
openssl x509 -text CERT

=== Hands-On Lab: Working with OpenSSL and Httpd ===
Open your terminal application, and run the following command (remember to replace <PUBLIC_IP> with the public IP you were provided on the lab instructions page):
ssh cloud_user@&lt;PUBLIC_IP&gt;

Type yes at the prompt.
Enter your cloud_user password at the prompt.

Install mod_ssl on the Host webserver
Log in to the webserver host.
ssh webserver
Escalate privileges to root.
sudo su -

Install mod_ssl.
yum install -y mod_ssl

Generate and Sign a Private Key
Change to the /tls/ directory.
cd /etc/pki/tls/

Create a new encrypted private key.
openssl genrsa -aes128 -out private/httpdkey.pem

Enter httpd at the next two passphrase prompts.
Generate a self-signed certificate using the encrypted private key.
openssl req -new -x509 -key private/httpdkey.pem -out certs/httpdcert.pem -days 365

Enter httpd at the passphrase prompt.
At the next prompt, enter the following information:
Country Name: US
State or Province Name: Texas
Locality Name: Dallas
Organization Name: Example Corp
Common Name: shop.example.com
Email Address: webmaster@example.com

Configure the Default Apache Virtual Host
Edit /etc/httpd/conf.d/ssl.conf.
vim /etc/httpd/conf.d/ssl.conf

Type /Virtual to search for the SSH Virtual Host Context section.
At the end of the <VirtualHost _default_:443> section, add the following on a new line:
ServerName shop.example.com:443

Type /SSLCert to search for the Server Certificate section.
Locate the line SSLCertificateFile /etc/pki/tls/certs/localhost.crt, and change it to the following:
SSLCertificateFile /etc/pki/tls/certs/httpdcert.pem

Locate the line SSLCertificateKeyFile /etc/pki/tls/private/localhost.key, and change it to the following:
SSLCertificateKeyFile /etc/pki/tls/private/httpdkey.pem

Press Esc, then type :wq to exit the vim text editor.
Restart the Apache httpd server.
systemctl restart httpd

Enter httpd at the passphrase prompt.
Open port 443 on the OS firewall.
firewall-cmd --add-service=https --permanent

Reload the firewall.
firewall-cmd --reload

Verify the Configuration

Press Ctrl + D twice to log out of webserver and return to workstation.
Verify that the configuration is working properly.
openssl s_client -connect shop.example.com:443

Press Ctrl + C to return to the command prompt.
Write the s_client output to a file.
openssl s_client -connect shop.example.com:443 > /home/cloud_user/httpd_output

List the contents of the file to verify that the certificate information is there.
cat /home/cloud_user/httpd_output

== 325.3 Encrypted Files Systems ==
=== Creating Encrypted Volumes ===
Disk Encryption Concepts
File System Encryption with eCryptfs
Working with LUKS

Use cases of disk encryption
Protect data at rest
Protect removable media
Add additional data security such as an onboard drive

Methods of disk encryption
Block device - LUKS
File system level - eCryptfs

Disk encryption tools
em-encrypt and luks
cryptmount
eCryptfs
EncFS

Disk Encryption with eCryptfs and EncFS
eCryptfs provides file system level encryption
Uses ecryptfs package
Mount a new directory using the ecryptfs type
PAM module provided for automatic mounting options
ecryptfs-utils provides helper utilities
EncFS is similar but targets non-superusers
Allows for creation of encrypted repos by standard users

=== Demo: Working with LUKS ===
Working with LUKS
Create encrypted volumes
cryptsetup luksFormat DEVICE
cryptsetup luksOpen DEVICE mapping

mapping can be anything you'd like, it's a name

Luks Keys
Example LUKS key
dd if=/dev/urandom of=/root/lukskey bs=4096 count=1
cryptsetup luksAddKey DEVICE keyfile

Mount on boot with Crypttab
/etc/crypttab
mapping DEVICE keyfile filesystemtype (luks)

/etc/fstab

mount -a will not work
Must reboot

=== Hands-On Lab: Disk Encryption with eCryptfs ===
Install eCryptfs

Run the following command:
sudo apt-get install ecryptfs-utils

Type y at the prompt.

Configure /opt/protected as an Encrypted Mount
Ensure that the /opt/protected directory exists.
ll /opt/

Encrypt the file system.
sudo mount -t ecryptfs /opt/protected /opt/protected

Type supersecret! at the passphrase prompt.
Press Enter to accept the default options at the next two prompts.
Type y to accept the defaults at the next two prompts.
Type yes at the next two prompts.

Copy the Contents of /etc/profile.d to /opt/protected
Run the following command:
sudo cp /etc/profile.d/* /opt/protected/

Verify that the file is readable.
cat /opt/protected/apps-bin-path.sh

Re-encrypt /opt/protected and Verify that the Contents of the Directory Are Unreadable
Unmount the file system.

sudo umount /opt/protected

Attempt to view the contents of one of the files in /opt/protected.
cat /opt/protected/apps-bin-path.sh

== 325.4 DNS and Cryptography ==
=== Working with DNS ===
Working with DNS
Securing DNS with DNSSEC
DNS is short for Domain Name System
DNS is a hierarchical system used to resolve hostnames
Starts with a root server that branches
Resolves attempt to lookup hostnames against local forwarders if configured
Resolvers will go directly to the root name server which delegates
Zones and resource records
DNS configurations are made up of zones and resource records (RRs)
Consist of a type and a series of labels that make up domains, subdomains, hosts etc.

EDNS proposed
Extension for DNS
Documented in RFC 2671
Address backwards compatibility for older versions of DNS

BIND is a popular implementation of a DNS server
Primary config is /etc/named.conf
Objectives on LPIC exam 303 cover securing DNS with BIND in particular

Securing BIND
Means of securing DNS
TSIGs - a method of digitally signing data provided to a resolver or data sent in a zone transfer.
DNS poisoning can occur without TSIGs
Running a named server in a chroot jail
Restrict access
Configuration directives
Allow query
Recursion
Prevent DNS from reaching out to other servers
Allow Transfer
What DNS servers are allowed to transfer zones

RNDC stands for Remote Name server Daemon Control
Allows for remote name server management
Remote control for bind
Secure with a key
Must be secured using a secret key that is shared with the BIND server.

BIND Configuration
Directives:
allow query
recursion
allow transfer

DNS utilities
dig
New version called delv

=== Securing DNS with DNSSEC ===

=== Understanding DANE ===

== 326.1 Host Hardening ==
=== Kernel Security Part 1 ===
=== Kernel Security Part 2 ===
=== Securing Grub ===
=== Hands-On Lab: Linux Kernel Security ===

== 326.2 Host Intrustion Detection ==
=== Threat Detection ===
=== Working with Maldet ===
=== Understanding Rootkits ===
=== System Auditing in Linux ===
=== Hands-On Lab: Working with the Audit Log ===

== 326.3 User Management and Authentication ==
=== Linux Login Essentials ===
=== PAM Concepts ===
=== Kerberos Concepts ===
=== Understanding SSSD ===
=== Hands-On Lab: Configuring PAM ===
=== Hands-On Lab: Configuring SSSD ===

== 326.4 FreeIPA Installation and Samba Integration ==
=== Overview of FreeIPA ===
=== Installing and Configuring FreeIPA ===
=== Working with FreeIPA ===
=== Hands-On Lab: Working with FreeIPA ===

== 327.1 Discretionary Access Control ==
=== Basic System Permissions ===
=== Extended Attributes ===
=== Using ACLs ===
=== Hands-On Lab: Managing File Attributes and Permissions ===

== 327.2 Mandatory Access Control ==
=== Understanding MAC ===
=== SELinux ===
=== AppArmor and Smack: MAC alternatives ===
=== Hands-On Lab: Troubleshooting SELinux ===

== 327.3 Network File Systems ==
=== NFSv4 Improvements ===
=== NFS in Practice ===
=== NFS4 ACLs ===
=== CIFS Configuration ===
=== Hands-On Lab: Exporting an NFSv4 Volume with ACLs ===

== 328.1 Network Hardening ==
=== Configuring FreeRADIUS ===
=== Analyzing Network Traffic ===
=== Network Utilities and Threats ===
=== Hands-On Lab: Packet Capture and Analysis ===

== 328.2 Network Intrustion Detection ==
=== Network Monitoring ===
=== Configure and Use Snort ===
=== OpenVAS Overview ===

== 328.3 Packet filtering ==
=== Firewall Concepts ===
=== Advanced Firewall Concepts ===
=== Ebtables and Nftables ===
=== Hands-On Lab: Working with IP Sets and iptables ===

== 328.4 Virtuan Private Networks ==
=== OpenVPN ===
=== IPSec Concepts ===
=== Hands-On Lab: Working with OpenVPN (and iptables) ===
